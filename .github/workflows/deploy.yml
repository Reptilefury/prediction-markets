name: Deploy to Cloud Run

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  PROJECT_ID: heroic-equinox-474616-i5
  SERVICE_NAME: prediction-markets
  REGION: us-central1
  REGISTRY: gcr.io

jobs:
  pre-deployment-checks:
    runs-on: ubuntu-latest
    name: Pre-deployment Security & Quality Checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: Final Build & Test
      run: ./mvnw clean package -DskipTests
      
    - name: Install Snyk CLI
      run: |
        curl -Lo ./snyk "https://github.com/snyk/snyk/releases/latest/download/snyk-linux"
        chmod +x ./snyk
        
    - name: Final Security Scan
      run: |
        ./snyk auth ${{ secrets.SNYK_TOKEN }}
        ./snyk test --severity-threshold=high --fail-on=upgradable
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        
    - name: Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Configure Docker for GCR
      run: gcloud auth configure-docker gcr.io
      
    - name: Build Production Image
      run: |
        docker build -t $REGISTRY/$PROJECT_ID/$SERVICE_NAME:${{ github.sha }} .
        
    - name: Final Trivy Security Scan
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
        
    - name: Push Image to GCR
      run: |
        docker push $REGISTRY/$PROJECT_ID/$SERVICE_NAME:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    name: Deploy to Cloud Run
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Deploy to Cloud Run
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
        DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
        JDBC_DATABASE_URL: ${{ secrets.JDBC_DATABASE_URL }}
        REDIS_HOST: ${{ secrets.REDIS_HOST }}
        REDIS_PORT: ${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        BASE_URL: ${{ secrets.BASE_URL }}
        MAGIC_API_KEY: ${{ secrets.MAGIC_API_KEY }}
        MAGIC_API_URL: ${{ secrets.MAGIC_API_URL }}
        ENCLAVE_API_KEY: ${{ secrets.ENCLAVE_API_KEY }}
        ENCLAVE_API_URL: ${{ secrets.ENCLAVE_API_URL }}
        BLNK_API_URL: ${{ secrets.BLNK_API_URL }}
        BLNK_LEDGER_ID: ${{ secrets.BLNK_LEDGER_ID }}
        KEYCLOAK_BASE_URL: ${{ secrets.KEYCLOAK_BASE_URL }}
        KEYCLOAK_REALM: ${{ secrets.KEYCLOAK_REALM }}
        KEYCLOAK_CLIENT_ID: ${{ secrets.KEYCLOAK_CLIENT_ID }}
        KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}
        WALLETCONNECT_PROJECT_ID: ${{ secrets.WALLETCONNECT_PROJECT_ID }}
        DYNAMIC_ENVIRONMENT_ID: ${{ secrets.DYNAMIC_ENVIRONMENT_ID }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        PUBSUB_TOPIC_WALLET: ${{ secrets.PUBSUB_TOPIC_WALLET }}
        PUBSUB_SUBSCRIPTION_WALLET: ${{ secrets.PUBSUB_SUBSCRIPTION_WALLET }}
        APP_ENCLAVE_DESTINATION_TOKEN_ADDRESS: ${{ secrets.APP_ENCLAVE_DESTINATION_TOKEN_ADDRESS }}
        LOGODEV_API_KEY: ${{ secrets.LOGODEV_API_KEY }}
        LOGODEV_PUBLISHABLE_KEY: ${{ secrets.LOGODEV_PUBLISHABLE_KEY }}
        CRYPTO_SERVICE_URL: ${{ secrets.CRYPTO_SERVICE_URL }}
      run: |
        gcloud run deploy $SERVICE_NAME \
          --image=$REGISTRY/$PROJECT_ID/$SERVICE_NAME:${{ github.sha }} \
          --platform managed \
          --region $REGION \
          --allow-unauthenticated \
          --ingress=internal-and-cloud-load-balancing \
          --timeout=600 \
          --port=8080 \
          --memory=2Gi \
          --cpu=2 \
          --min-instances=1 \
          --max-instances=10 \
          --set-env-vars="SPRING_PROFILES_ACTIVE=prod,DATABASE_URL=${DATABASE_URL},DATABASE_USERNAME=${DATABASE_USERNAME},DATABASE_PASSWORD=${DATABASE_PASSWORD},JDBC_DATABASE_URL=${JDBC_DATABASE_URL},REDIS_HOST=${REDIS_HOST},REDIS_PORT=${REDIS_PORT},REDIS_PASSWORD=${REDIS_PASSWORD},BASE_URL=${BASE_URL},MAGIC_API_KEY=${MAGIC_API_KEY},MAGIC_API_URL=${MAGIC_API_URL},ENCLAVE_API_KEY=${ENCLAVE_API_KEY},ENCLAVE_API_URL=${ENCLAVE_API_URL},BLNK_API_URL=${BLNK_API_URL},BLNK_LEDGER_ID=${BLNK_LEDGER_ID},KEYCLOAK_BASE_URL=${KEYCLOAK_BASE_URL},KEYCLOAK_REALM=${KEYCLOAK_REALM},KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID},KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET},WALLETCONNECT_PROJECT_ID=${WALLETCONNECT_PROJECT_ID},DYNAMIC_ENVIRONMENT_ID=${DYNAMIC_ENVIRONMENT_ID},GCP_PROJECT_ID=${GCP_PROJECT_ID},PUBSUB_TOPIC_WALLET=${PUBSUB_TOPIC_WALLET},PUBSUB_SUBSCRIPTION_WALLET=${PUBSUB_SUBSCRIPTION_WALLET},APP_ENCLAVE_DESTINATION_TOKEN_ADDRESS=${APP_ENCLAVE_DESTINATION_TOKEN_ADDRESS},LOGODEV_API_KEY=${LOGODEV_API_KEY},LOGODEV_PUBLISHABLE_KEY=${LOGODEV_PUBLISHABLE_KEY},CRYPTO_SERVICE_URL=${CRYPTO_SERVICE_URL}"
          
    - name: Post-deployment Health Check
      run: |
        SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format='value(status.url)')
        echo "Service URL: $SERVICE_URL"
        
        # Wait for service to be ready
        sleep 30
        
        # Try multiple health check endpoints
        if curl -f "$SERVICE_URL/actuator/health" 2>/dev/null; then
          echo "Health check passed via /actuator/health"
        elif curl -f "$SERVICE_URL/health" 2>/dev/null; then
          echo "Health check passed via /health"
        elif curl -f "$SERVICE_URL/" 2>/dev/null; then
          echo "Health check passed via root endpoint"
        else
          echo "All health check endpoints failed, but service is deployed"
          echo "Manual verification required at: $SERVICE_URL"
        fi
